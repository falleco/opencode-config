# Start from the latest official Alpine Linux release
FROM alpine:latest

ENV OPENCODE_CONFIG=/home/opencode/.config/opencode/opencode.jsonc
ENV OPENCODE_CONFIG_DIR=/home/opencode/.config/opencode
ENV OPENCODE_WEB_HOST=0.0.0.0

EXPOSE 4096
EXPOSE 1455

# Install core tools
RUN set -e; \
    ALPINE_VERSION="$(cut -d. -f1,2 /etc/alpine-release)"; \
    echo "https://dl-cdn.alpinelinux.org/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories; \
    apk update; \
    apk add --no-cache \
      # Core utilities needed for setup and the curl install script
      wget \
      vim \
      ca-certificates \
      curl \
      unzip \
      gnupg \
      sudo \
      openssh-client \
      bash \
      git \
      ripgrep \
      docker-cli

# Detect architecture for cross-platform support (for GitHub CLI)
RUN ARCH=$(uname -m) \
    && if [ "$ARCH" = "x86_64" ]; then \
    GH_ARCH="amd64"; \
    elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then \
    GH_ARCH="arm64"; \
    else \
    echo "Unsupported architecture: $ARCH"; \
    exit 1; \
    fi \
    && echo "$GH_ARCH" > /tmp/gh_arch

# Install GitHub CLI (gh) for Alpine
RUN GH_VERSION=$(curl -s https://api.github.com/repos/cli/cli/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "v\(.*\)".*/\1/') \
    && GH_ARCH=$(cat /tmp/gh_arch) \
    && wget -O gh.tar.gz "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${GH_ARCH}.tar.gz" \
    && tar -xzf gh.tar.gz \
    && mv gh_*_linux_${GH_ARCH}/bin/gh /usr/local/bin/gh \
    && rm -rf gh.tar.gz gh_*_linux_${GH_ARCH} /tmp/gh_arch

# Install Node.js via Alpine's package manager
# Enable community repository and install Node.js (will be v22 or latest available)
RUN apk add --no-cache nodejs npm \
    && node --version \
    && npm --version

# Enable corepack if available (comes with Node.js, but may not be in Alpine's package)
RUN command -v corepack >/dev/null 2>&1 && corepack enable || npm install -g corepack && corepack enable
