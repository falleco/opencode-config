services:
  opencode:
    build:
      context: .
      dockerfile: docker/Dockerfile.opencode
    container_name: opencode-web
    # Load environment variables from root .env file
    env_file:
      - .env
    ports:
      - "${OPENCODE_PORT:-4096}:4096"
      - "1455:1455"
    depends_on:
      opencode-dind:
        condition: service_healthy
      opencode-worker-build:
        condition: service_completed_successfully
    volumes:
      # Map the opencode folder to the container
      - ./opencode:/home/opencode/.config/opencode
      # Project roots (UI expects .config/opencode/projects)
      - /Users/falleco/projects/ai:/home/opencode/projects
      - /Users/falleco/projects/ai:/home/opencode/.config/opencode/projects
      # Map OpenCode auth directory for persistence
      - ./.state:/home/opencode/.local/share/opencode
      # Docker TLS certs from dind
      - opencode-dind-certs:/certs:ro
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
      - OPENCODE_CONFIG=${OPENCODE_CONFIG:-/home/opencode/.config/opencode/opencode.jsonc}
      - OPENCODE_CONFIG_DIR=${OPENCODE_CONFIG_DIR:-/home/opencode/.config/opencode}
      - OPENCODE_WEB_HOST=${OPENCODE_WEB_HOST:-0.0.0.0}
    networks:
      - opencode-net
    restart: unless-stopped

  opencode-dind:
    image: docker:27-dind
    container_name: opencode-dind
    privileged: true
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      - opencode-dind-data:/var/lib/docker
      - opencode-dind-certs:/certs
      - /Users/falleco/projects/ai:/home/opencode/projects
    networks:
      opencode-net:
        aliases:
          - docker
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 10s

  opencode-worker-build:
    image: docker:27-cli
    container_name: opencode-worker-build
    depends_on:
      opencode-dind:
        condition: service_healthy
    environment:
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
    volumes:
      - ./:/workspace
      - opencode-dind-certs:/certs:ro
    working_dir: /workspace
    command:
      [
        "sh",
        "-lc",
        "docker build -f /workspace/docker/Dockerfile.worker -t opencode-worker:latest /workspace"
      ]
    networks:
      - opencode-net
    restart: "no"

volumes:
  opencode-auth:
  opencode-dind-data:
  opencode-dind-certs:

networks:
  opencode-net:
