services:
  #####################
  # OpenCode Web Mode #
  #####################
  opencode:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: opencode-web
    env_file:
      - .env
    volumes:
      - ./opencode:/home/opencode/.config/opencode
      - ${OPENCODE_PROJECTS_DIR:-~/projects/ai}:/home/opencode/projects
      - ./.state:/home/opencode/.local/share/opencode
      - opencode-dind-certs:/certs:ro
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - OPENCODE_CONFIG=${OPENCODE_CONFIG:-/home/opencode/.config/opencode/opencode.jsonc}
      - OPENCODE_CONFIG_DIR=${OPENCODE_CONFIG_DIR:-/home/opencode/.config/opencode}
      - OPENCODE_WEB_HOST=${OPENCODE_WEB_HOST:-0.0.0.0}
      - HTTP_PROXY=http://egress-proxy:3128
      - HTTPS_PROXY=http://egress-proxy:3128
      - NO_PROXY=localhost,127.0.0.1,::1,egress-proxy,docker
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
      # - OPENCODE_VERSION=${OPENCODE_VERSION:-1.1.34}
    networks:
      - opencode-internal
    depends_on:
      - egress-proxy
    restart: unless-stopped

  ################
  # Egress Proxy #
  ################
  egress-proxy:
    build:
      context: ./egress
      dockerfile: Dockerfile
    container_name: opencode-egress-proxy
    ports:
      - "3128:3128"
    expose:
      - "3128"
    volumes:
      - ./egress/allowed-domains.txt:/etc/squid/allowed-domains.txt:ro
      - ./egress/allowed-ips.txt:/etc/squid/allowed-ips.txt:ro
    networks:
      - opencode-internal
      - opencode-egress
    read_only: true
    dns:
      - 1.1.1.1
      - 8.8.8.8
    tmpfs:
      - /tmp
      - /var/cache/squid
      - /var/log/squid
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  #####################
  #   Ingress Proxy   #
  #####################
  ingress-proxy:
    image: nginx:alpine
    container_name: opencode-ingress-proxy
    ports:
      - "${OPENCODE_PORT:-4096}:4096"
      - "1455:1455"
      - "3000:3000"
      - "7900:7900"
    volumes:
      - ./ingress/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ingress/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - opencode-internal
      - opencode-ingress
    read_only: true
    dns:
      - 1.1.1.1
      - 8.8.8.8
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    security_opt:
      - no-new-privileges:true
    depends_on:
      - opencode
    restart: unless-stopped

  ########################
  #   Docker-in-Docker   #
  ########################
  docker-dind:
    image: docker:27-dind
    container_name: opencode-dind
    privileged: true
    entrypoint:
      - /bin/sh
      - /usr/local/bin/dind-entrypoint.sh
    environment:
      - DOCKER_TLS_CERTDIR=/certs
      - HTTP_PROXY=http://egress-proxy:3128
      - HTTPS_PROXY=http://egress-proxy:3128
      - NO_PROXY=localhost,127.0.0.1,::1,egress-proxy,docker
    networks:
      opencode-internal:
        aliases:
          - docker
      opencode-egress:
        aliases:
          - docker
    volumes:
      - ./docker-dind/entrypoint.sh:/usr/local/bin/dind-entrypoint.sh:ro
      - opencode-dind-data:/var/lib/docker
      - opencode-dind-certs:/certs
      - ${OPENCODE_PROJECTS_DIR:-~/projects/ai}:/home/opencode/projects
      - /tmp
    init: true
    stop_grace_period: 30s
    restart: unless-stopped

  ########################
  #   Docker-in-Docker   #
  ########################
  dind-proxy:
    image: alpine/socat
    container_name: opencode-dind-proxy
    network_mode: service:docker-dind
    depends_on:
      - docker-dind
      - egress-proxy
    command:
      - -d
      - -d
      - TCP-LISTEN:3128,fork,reuseaddr
      - TCP:egress-proxy:3128
    restart: unless-stopped


###############
#   Volumes   #
###############
volumes:
  opencode-auth:
  opencode-dind-data:
  opencode-dind-certs:

################
#   Networks   #
################
networks:
  opencode-internal:
    internal: true
  opencode-egress:
  opencode-ingress:
